"use strict";const e=require("../../common/vendor.js"),a=require("../../stores/auth.js"),o=require("../../api/index.js");if(!Array){(e.resolveComponent("uni-load-more")+e.resolveComponent("uni-icons")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-data-checkbox")+e.resolveComponent("uni-list")+e.resolveComponent("uni-forms"))()}Math||((()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-load-more/uni-load-more.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-icons/uni-icons.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-forms-item/uni-forms-item.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-easyinput/uni-easyinput.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-data-checkbox/uni-data-checkbox.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-list/uni-list.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-forms/uni-forms.js"))();const n={__name:"profile",setup(n){const l=a.useAuthStore(),t=e.ref(null),s=e.ref(!0),u=e.ref(""),i=e.ref(!1),r=e.ref({}),d=e.ref({}),c=e.ref([{text:"男",value:"MALE"},{text:"女",value:"FEMALE"},{text:"其他",value:"OTHER"}]),v={name:{rules:[{required:!0,errorMessage:"昵称不能为空"}]}},m=e=>{const a=c.value.find((a=>a.value===e));return a?a.text:"未设置"},p=async()=>{i.value&&e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:async a=>{const n=a.tempFilePaths[0];e.index.showLoading({title:"正在上传头像..."});try{const a=await o.getOssStsCredentials();if(200!==a.code||!a.data)throw new Error("获取上传凭证失败");const l=a.data,t=l.accessKeyId||l.access_key_id,s=l.accessKeySecret||l.access_key_secret,u=l.securityToken||l.security_token,i=l.bucketName||l.bucket_name,c=l.region;if(!t||!s)throw new Error("获取到的上传凭证不完整！");const v=(new Date).getTime()+36e5,m={expiration:new Date(v).toISOString(),conditions:[["content-length-range",0,10485760]]},p=e.CryptoJs.enc.Base64.stringify(e.CryptoJs.enc.Utf8.parse(JSON.stringify(m))),h=e.CryptoJs.enc.Base64.stringify(e.CryptoJs.HmacSHA1(p,s)),f=`https://${i}.${c}.aliyuncs.com`,y=`avatars/${r.value.uuid}/${(new Date).getTime()}${n.substring(n.lastIndexOf("."))}`,g=`${f}/${y}`;e.index.uploadFile({url:f,filePath:n,name:"file",formData:{key:y,policy:p,OSSAccessKeyId:t,signature:h,"x-oss-security-token":u,success_action_status:"200"},success:a=>{200===a.statusCode?(e.index.showToast({title:"上传成功!",icon:"success"}),d.value.avatar_url=g):(console.error("OSS Upload Error:",a.data),e.index.showToast({title:"上传到OSS失败",icon:"none"}))},fail:e=>{}})}catch(l){}}})},h=async()=>{s.value=!0,u.value="";try{const e=await o.getUserProfile();if(200!==e.code||!e.data)throw new Error(e.message||"获取用户信息失败");r.value=e.data}catch(e){u.value=e.message}finally{s.value=!1}},f=e=>{i.value=e,e&&(d.value={...r.value})},y=()=>{t.value.validate().then((async a=>{e.index.showLoading({title:"正在保存..."});try{const a={name:d.value.name,phone_number:d.value.phone_number,address:d.value.address,avatar_url:d.value.avatar_url,gender:d.value.gender,description:d.value.description},n=await o.updateUserProfile(a);e.index.hideLoading(),200===n.code?(e.index.showToast({title:"保存成功",icon:"success"}),i.value=!1,h()):e.index.showToast({title:n.message||"保存失败",icon:"none"})}catch(n){e.index.hideLoading(),e.index.showToast({title:"网络错误",icon:"none"})}}))},g=()=>{e.index.showModal({title:"提示",content:"确定要退出登录吗？",success:a=>{a.confirm&&(o.refreshToken(),e.index.showToast({title:"已退出"}),e.index.reLaunch({url:"/pages/auth/login"}))}})};return e.onShow((()=>{l.isAuthenticated?h():e.index.reLaunch({url:"/pages/auth/login"})})),(a,o)=>e.e({a:s.value},s.value?{b:e.p({status:"loading"})}:u.value?{d:e.t(u.value),e:e.o(h)}:e.e({f:d.value.avatar_url||"/static/default-avatar.png",g:i.value},i.value?{h:e.p({type:"camera-filled",color:"#fff",size:"24"})}:{},{i:e.o(p),j:e.t(r.value.name||"未设置昵称"),k:e.t(r.value.company_name||"未关联公司"),l:!i.value},i.value?{}:{m:e.o((e=>f(!0)))},{n:e.t(r.value.email),o:e.p({label:"邮箱",name:"email"}),p:i.value},i.value?{q:e.o((e=>d.value.name=e)),r:e.p({placeholder:"请输入昵称",modelValue:d.value.name})}:{s:e.t(r.value.name||"未填写")},{t:e.p({label:"昵称",name:"name"}),v:i.value},i.value?{w:e.o((e=>d.value.phone_number=e)),x:e.p({placeholder:"请输入电话号码",modelValue:d.value.phone_number})}:{y:e.t(r.value.phone_number||"未填写")},{z:e.p({label:"电话",name:"phone_number"}),A:i.value},i.value?{B:e.o((e=>d.value.gender=e)),C:e.p({localdata:c.value,modelValue:d.value.gender})}:{D:e.t(m(r.value.gender))},{E:e.p({label:"性别",name:"gender"}),F:i.value},i.value?{G:e.o((e=>d.value.address=e)),H:e.p({type:"textarea",placeholder:"请输入地址",modelValue:d.value.address})}:{I:e.t(r.value.address||"未填写")},{J:e.p({label:"地址",name:"address"}),K:i.value},i.value?{L:e.o((e=>d.value.description=e)),M:e.p({type:"textarea",placeholder:"请输入个人简介",modelValue:d.value.description})}:{N:e.t(r.value.description||"未填写")},{O:e.p({label:"简介",name:"description"}),P:e.sr(t,"b421b780-2",{k:"form"}),Q:e.p({modelValue:d.value,rules:v,"label-width":"80px"}),R:i.value},i.value?{S:e.o(y),T:e.o((e=>f(!1)))}:{},{U:e.o(g)}),{c:u.value})}},l=e._export_sfc(n,[["__scopeId","data-v-b421b780"]]);wx.createPage(l);
