"use strict";const e=require("../common/vendor.js"),t="http://172.22.120.244:8087";let r=!1,a=[];const s=(e,t=null)=>{a.forEach((r=>e?r.reject(e):r.resolve(t))),a=[]};async function o(i){var n;const{params:u,...d}=i;"GET"===(null==(n=i.method)?void 0:n.toUpperCase())&&u&&(d.data={...d.data||{},...u});const l=e.index.getStorageSync("access_token"),p={"Content-Type":"application/json",...d.header||{}};l&&(p.Authorization="Bearer "+l);try{const n=await e.index.request({...d,url:t+d.url,header:p});if(401===n.statusCode){const n=await async function(){if(r)return new Promise((e=>{a.push({resolve:e,reject:()=>{}})})).then((e=>o({url:originalRequest.url,method:originalRequest.method,data:originalRequest.data})));r=!0;const i=e.index.getStorageSync("refresh_token");if(!i)return r=!1,e.index.reLaunch({url:"/pages/auth/login"}),Promise.reject(new Error("No refresh token."));try{console.log("🔄 开始刷新Token...");const a=await e.index.request({url:t+"/api/auth/refresh",method:"POST",data:{refresh_token:i}});if(200===a.statusCode&&200===a.data.code){console.log("✅ Token刷新成功");const{access_token:t,refresh_token:r}=a.data.data;return e.index.setStorageSync("access_token",t),r&&e.index.setStorageSync("refresh_token",r),s(null,t),t}throw new Error("Failed to refresh token from server.")}catch(n){return console.error("❌ Token刷新失败:",n),e.index.removeStorageSync("access_token"),e.index.removeStorageSync("refresh_token"),s(n,null),e.index.reLaunch({url:"/pages/auth/login"}),Promise.reject(n)}finally{r=!1}}();return i.header||(i.header={}),i.header.Authorization=`Bearer ${n}`,await o(i)}return n.data}catch(c){return e.index.showToast({title:"网络连接异常",icon:"none"}),Promise.reject(c)}}exports.cancelMeetingParticipation=e=>o({url:`/api/user/meeting/participant/cancel?part_uuid=${e}`,method:"DELETE"}),exports.generateVerifyCode=e=>o({url:"/api/auth/generate-verify-code",method:"POST",data:e}),exports.getAllCourses=e=>o({url:"/api/user/lesson/all",method:"GET",params:{page:e.page,size:e.pageSize}}),exports.getAllMeetings=e=>{const{page:t=0,size:r=10}=e;return o({url:"/api/user/meeting/list",method:"GET",params:{page:t,size:r}})},exports.getCourseDetail=e=>o({url:"/api/user/lesson/detail",method:"GET",data:{uuid:e}}),exports.getMeetingDetail=e=>o({url:"/api/user/meeting/",method:"GET",params:{meeting_uuid:e}}),exports.getMyMeetingParts=e=>{const{page:t=1,size:r=10}=e;return o({url:"/api/user/meeting/part/list",method:"GET",params:{page:t,size:r}})},exports.getNewsDetail=e=>o({url:`/api/user/news/getNews/${e}`,method:"GET"}),exports.getNewsList=e=>{const t={};return e&&(void 0!==e.page&&null!==e.page&&(t.page=e.page),void 0!==e.pageSize&&null!==e.pageSize&&(t.pageSize=e.pageSize),e.startTime&&(t.startTime=e.startTime),e.endTime&&(t.endTime=e.endTime),e.summary&&(t.summary=e.summary),e.title&&(t.title=e.title)),o({url:"/api/user/news/newsList",method:"GET",data:t})},exports.getOssStsCredentials=()=>o({url:"/api/oss/sts",method:"GET"}),exports.getUserProfile=()=>o({url:"/api/client/user/me",method:"GET"}),exports.joinMeeting=e=>o({url:"/api/user/meeting/participant",method:"POST",data:e}),exports.refreshToken=e=>o({url:"/api/auth/login/refresh",method:"POST",data:e}),exports.registerIndividual=e=>o({url:"/api/auth/register/individual",method:"POST",data:e}),exports.searchCourses=e=>{const t=[];t.push(`key_word=${encodeURIComponent(e.key_word||"")}`),t.push(`page=${e.page||0}`),t.push(`size=${e.pageSize||1}`);return o({url:`/api/user/lesson/search?${t.join("&")}`,method:"GET"})},exports.searchMeetingsByName=e=>o({url:"/api/user/meeting/versions/search/by-name",method:"GET",data:{name:e.name,page:e.page,size:e.size}}),exports.updateUserProfile=e=>o({url:"/api/client/user/me",method:"PUT",data:e}),exports.userLogin=e=>o({url:"/api/auth/login/user",method:"POST",data:e}),exports.verifyCode=e=>o({url:"/api/auth/verify-code",method:"POST",data:e});
